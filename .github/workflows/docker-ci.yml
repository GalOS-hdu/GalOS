name: Docker CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

# Cancel in-progress runs when a new workflow with the same group name is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [riscv64, loongarch64, x86_64, aarch64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Free disk space
      run: |
        echo "Before cleanup:"
        df -h

        # Remove unnecessary packages to free up disk space
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"

        # Clean up docker
        docker system prune -af --volumes

        # Clean apt cache
        sudo apt-get clean

        echo "After cleanup:"
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker image
      run: |
        docker compose build --build-arg BUILDKIT_INLINE_CACHE=1

    - name: Build GalOS for ${{ matrix.arch }}
      run: |
        docker compose run --rm galos-dev \
          bash -c "make ARCH=${{ matrix.arch }} build"

    - name: Prepare rootfs for ${{ matrix.arch }}
      run: |
        docker compose run --rm galos-dev \
          bash -c "make ARCH=${{ matrix.arch }} img"

    - name: Run CI tests for ${{ matrix.arch }}
      run: |
        docker compose run --rm galos-dev \
          bash -c "python3 scripts/ci-test.py ${{ matrix.arch }}"
      timeout-minutes: 10

    - name: Upload test artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ matrix.arch }}
        path: |
          qemu.log
          *.pcap
        retention-days: 7

  docker-build-only:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Free disk space
      run: |
        echo "Before cleanup:"
        df -h

        # Remove unnecessary packages to free up disk space
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"

        # Clean up docker
        docker system prune -af --volumes

        # Clean apt cache
        sudo apt-get clean

        echo "After cleanup:"
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker compose build

    - name: Verify environment
      run: |
        docker compose run --rm galos-dev bash -c "
          rustc --version && \
          qemu-system-riscv64 --version && \
          qemu-system-loongarch64 --version && \
          qemu-system-x86_64 --version && \
          qemu-system-aarch64 --version && \
          riscv64-linux-musl-gcc --version && \
          loongarch64-linux-musl-gcc --version && \
          aarch64-linux-musl-gcc --version && \
          x86_64-linux-musl-gcc --version
        "
