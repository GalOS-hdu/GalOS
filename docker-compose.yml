services:
  galos-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        QEMU_VERSION: "9.2.4"
        RUST_VERSION: "nightly-2025-05-20"
        MUSL_TOOLCHAIN_VERSION: "20241227"
        USERNAME: starry
        USER_UID: 1000
        USER_GID: 1000
    image: galos-dev:latest
    container_name: galos-dev
    hostname: galos-dev

    # Volume mounts
    volumes:
      # Mount project directory
      - .:/workspace/GalOS
      # Persistent cargo cache
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git-cache:/usr/local/cargo/git
      # Persistent target directory (optional, for faster rebuilds)
      - target-cache:/workspace/GalOS/target

    # Working directory
    working_dir: /workspace/GalOS

    # Keep container running
    stdin_open: true
    tty: true

    # Environment variables
    environment:
      - ARCH=riscv64
      - LOG=warn
      - BACKTRACE=y
      - MEMTRACK=n
      # Rust environment
      - RUSTUP_DIST_SERVER=
      - CARGO_HOME=/usr/local/cargo
      - RUSTUP_HOME=/usr/local/rustup
      # Proxy configuration (can be overridden via .env file or environment variables)
      # Default: empty (no proxy). Set in .env file for local development if needed.
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - http_proxy=${http_proxy:-}
      - https_proxy=${https_proxy:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,::1}
      - no_proxy=${no_proxy:-localhost,127.0.0.1,::1}

    # Network mode (use 'host' to access host proxy on 127.0.0.1)
    network_mode: host

    # Privileged mode (optional, needed for KVM acceleration)
    # Uncomment if you want to use KVM acceleration
    # privileged: true
    # devices:
    #   - /dev/kvm:/dev/kvm

    # Resource limits (optional)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '8'
    #       memory: 16G
    #     reservations:
    #       cpus: '4'
    #       memory: 8G

  # CI test environment (lightweight, no volumes)
  galos-ci:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        QEMU_VERSION: "9.2.4"
        RUST_VERSION: "nightly-2025-05-20"
    image: galos-ci:latest
    container_name: galos-ci
    working_dir: /workspace/GalOS
    volumes:
      - .:/workspace/GalOS
    command: /bin/bash -c "make build && make img && python3 scripts/ci-test.py riscv64"
    profiles:
      - ci

volumes:
  cargo-cache:
    driver: local
  cargo-git-cache:
    driver: local
  target-cache:
    driver: local
